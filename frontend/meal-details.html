<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Details - ChopNow</title>
    <meta name="description" content="View detailed information about this meal and add it to your cart.">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üçΩÔ∏è</div>
                    <span class="logo-text">ChopNow</span>
                </a>
                
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="meals.html" class="nav-link">Browse Meals</a></li>
                </ul>
                
                <div class="nav-actions">
                    <div id="auth-links" class="flex gap-3">
                        <a href="login.html" class="btn btn-ghost">Sign In</a>
                        <a href="register.html" class="btn btn-secondary">Get Started</a>
                    </div>
                    
                    <div id="user-menu" class="flex items-center gap-4" style="display: none;">
                        <a href="cart.html" id="cart-link" class="nav-link cart-badge" style="display: none;">
                            üõí Cart
                            <span id="cart-count" class="cart-count">0</span>
                        </a>
                        <a href="#" id="dashboard-link" class="btn btn-ghost" style="display: none;">Dashboard</a>
                        <button id="logout-button" class="btn btn-ghost" style="display: none;">Sign Out</button>
                    </div>
                </div>
                
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    ‚ò∞
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-8">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb mb-6">
                <a href="index.html" class="breadcrumb-link">Home</a>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <a href="meals.html" class="breadcrumb-link">Meals</a>
                <span class="breadcrumb-separator">‚Ä∫</span>
                <span class="breadcrumb-current" id="meal-name-breadcrumb">Meal Details</span>
            </nav>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="spinner mx-auto mb-4" style="width: 40px; height: 40px;"></div>
                <p class="text-gray-600">Loading meal details...</p>
            </div>

            <!-- Meal Details Content -->
            <div id="meal-content" style="display: none;">
                <div class="grid grid-cols-2 gap-12 mb-12">
                    <!-- Meal Images -->
                    <div class="meal-images">
                        <div class="main-image mb-4">
                            <img id="main-meal-image" src="" alt="" class="w-full h-96 object-cover rounded-xl shadow-lg">
                            <div class="discount-badge">
                                <span id="discount-percentage" class="bg-success text-white px-3 py-1 rounded-full font-bold">
                                    0% OFF
                                </span>
                            </div>
                        </div>
                        
                        <!-- Additional Images (if any) -->
                        <div id="additional-images" class="grid grid-cols-4 gap-2">
                            <!-- Additional images will be loaded here -->
                        </div>
                    </div>

                    <!-- Meal Information -->
                    <div class="meal-info">
                        <div class="vendor-info mb-4">
                            <div class="flex items-center gap-3">
                                <div class="vendor-avatar">
                                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                                        <span id="vendor-initial">V</span>
                                    </div>
                                </div>
                                <div>
                                    <h3 id="vendor-name" class="font-semibold text-gray-800">Vendor Name</h3>
                                    <p id="vendor-address" class="text-sm text-gray-600">Vendor Address</p>
                                </div>
                            </div>
                        </div>

                        <h1 id="meal-title" class="text-3xl font-bold text-gray-900 mb-4">Meal Name</h1>
                        
                        <div class="rating-section mb-4">
                            <div class="flex items-center gap-2">
                                <div class="stars" id="meal-rating">
                                    <span class="text-yellow-500">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                </div>
                                <span id="rating-text" class="text-gray-600">(4.5)</span>
                                <span class="text-gray-400">‚Ä¢</span>
                                <span id="review-count" class="text-gray-600">12 reviews</span>
                            </div>
                        </div>

                        <div class="pricing mb-6">
                            <div class="flex items-center gap-3 mb-2">
                                <span id="discounted-price" class="text-3xl font-bold text-primary">$0.00</span>
                                <span id="original-price" class="text-xl text-gray-500 line-through">$0.00</span>
                            </div>
                            <div class="savings-info">
                                <span class="text-success font-semibold">You save <span id="savings-amount">$0.00</span></span>
                            </div>
                        </div>

                        <div class="meal-description mb-6">
                            <h3 class="font-semibold text-lg mb-3">Description</h3>
                            <p id="meal-description" class="text-gray-700 leading-relaxed">
                                Meal description will be loaded here...
                            </p>
                        </div>

                        <div class="meal-details-grid mb-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="detail-item">
                                    <h4 class="font-semibold text-gray-800 mb-1">Cuisine Type</h4>
                                    <p id="cuisine-type" class="text-gray-600">-</p>
                                </div>
                                <div class="detail-item">
                                    <h4 class="font-semibold text-gray-800 mb-1">Meal Type</h4>
                                    <p id="meal-type" class="text-gray-600">-</p>
                                </div>
                                <div class="detail-item">
                                    <h4 class="font-semibold text-gray-800 mb-1">Available Quantity</h4>
                                    <p id="available-quantity" class="text-gray-600">0 portions</p>
                                </div>
                                <div class="detail-item">
                                    <h4 class="font-semibold text-gray-800 mb-1">Pickup Time</h4>
                                    <p id="pickup-time" class="text-gray-600">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Dietary Information -->
                        <div id="dietary-info" class="mb-6" style="display: none;">
                            <h4 class="font-semibold text-gray-800 mb-3">Dietary Information</h4>
                            <div class="flex flex-wrap gap-2" id="dietary-tags">
                                <!-- Dietary tags will be loaded here -->
                            </div>
                        </div>

                        <!-- Allergen Information -->
                        <div id="allergen-info" class="mb-6" style="display: none;">
                            <h4 class="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Allergen Information</h4>
                            <div class="flex flex-wrap gap-2" id="allergen-tags">
                                <!-- Allergen tags will be loaded here -->
                            </div>
                        </div>

                        <!-- Add to Cart Section -->
                        <div class="add-to-cart-section">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="quantity-selector">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity</label>
                                    <div class="flex items-center">
                                        <button class="quantity-btn" onclick="updateQuantity(-1)">-</button>
                                        <span id="selected-quantity" class="quantity-display">1</span>
                                        <button class="quantity-btn" onclick="updateQuantity(1)">+</button>
                                    </div>
                                </div>
                                <div class="total-price">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Total</label>
                                    <span id="total-price" class="text-2xl font-bold text-primary">$0.00</span>
                                </div>
                            </div>

                            <div class="action-buttons">
                                <button id="add-to-cart-btn" class="btn btn-primary btn-lg w-full mb-3" onclick="addToCart()">
                                    Add to Cart
                                </button>
                                <div class="flex gap-3">
                                    <button class="btn btn-outline flex-1" onclick="toggleFavorite()">
                                        <span id="favorite-icon">ü§ç</span> Save for Later
                                    </button>
                                    <button class="btn btn-ghost flex-1" onclick="shareMeal()">
                                        üì§ Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div class="reviews-section">
                    <div class="section-header mb-6">
                        <h2 class="section-title">Customer Reviews</h2>
                        <div class="flex items-center gap-4">
                            <select id="review-sort" class="form-control" style="width: auto;">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="rating_high">Highest Rating</option>
                                <option value="rating_low">Lowest Rating</option>
                            </select>
                        </div>
                    </div>

                    <div id="reviews-container">
                        <!-- Reviews will be loaded here -->
                    </div>
                </div>

                <!-- Related Meals -->
                <div class="related-meals-section mt-12">
                    <div class="section-header mb-6">
                        <h2 class="section-title">More from this Vendor</h2>
                    </div>
                    <div id="related-meals" class="meals-grid">
                        <!-- Related meals will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="error-state" class="text-center py-12" style="display: none;">
                <div class="text-6xl mb-4">‚ùå</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Meal Not Found</h2>
                <p class="text-gray-600 mb-6">The meal you're looking for doesn't exist or has been removed.</p>
                <a href="meals.html" class="btn btn-primary">Browse Other Meals</a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom text-center">
                <p>&copy; 2025 ChopNow. All rights reserved. Made with ‚ù§Ô∏è for a sustainable future.</p>
            </div>
        </div>
    </footer>

    <script>
        let currentMeal = null;
        let selectedQuantity = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const mealId = urlParams.get('id');
            
            if (!mealId) {
                showError();
                return;
            }
            
            loadMealDetails(mealId);
        });

        async function loadMealDetails(mealId) {
            try {
                const response = await window.chopNowApp.makeRequest(`/meals/${mealId}`);
                currentMeal = response.meal;
                
                displayMealDetails(currentMeal);
                loadReviews(mealId);
                loadRelatedMeals(currentMeal.vendor_id, mealId);
                
            } catch (error) {
                console.error('Failed to load meal details:', error);
                showError();
            }
        }

        function displayMealDetails(meal) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('meal-content').style.display = 'block';
            
            // Update page title and breadcrumb
            document.title = `${meal.name} - ChopNow`;
            document.getElementById('meal-name-breadcrumb').textContent = meal.name;
            
            // Main image
            document.getElementById('main-meal-image').src = meal.image_url || 'https://via.placeholder.com/600x400?text=Delicious+Meal';
            document.getElementById('main-meal-image').alt = meal.name;
            
            // Discount badge
            const discountPercentage = Math.round(((meal.original_price - meal.discounted_price) / meal.original_price) * 100);
            document.getElementById('discount-percentage').textContent = `${discountPercentage}% OFF`;
            
            // Vendor info
            const vendorInitial = meal.vendor.businessName ? meal.vendor.businessName.charAt(0).toUpperCase() : 'V';
            document.getElementById('vendor-initial').textContent = vendorInitial;
            document.getElementById('vendor-name').textContent = meal.vendor.businessName || 'Local Vendor';
            document.getElementById('vendor-address').textContent = meal.vendor.businessAddress || 'Address not available';
            
            // Meal info
            document.getElementById('meal-title').textContent = meal.name;
            document.getElementById('meal-description').textContent = meal.description || 'No description available.';
            
            // Rating
            if (meal.average_rating > 0) {
                const stars = '‚≠ê'.repeat(Math.round(meal.average_rating));
                document.getElementById('meal-rating').innerHTML = `<span class="text-yellow-500">${stars}</span>`;
                document.getElementById('rating-text').textContent = `(${meal.average_rating.toFixed(1)})`;
                document.getElementById('review-count').textContent = `${meal.total_reviews} review${meal.total_reviews !== 1 ? 's' : ''}`;
            } else {
                document.getElementById('rating-text').textContent = 'New';
                document.getElementById('review-count').textContent = 'No reviews yet';
            }
            
            // Pricing
            document.getElementById('discounted-price').textContent = `$${meal.discounted_price}`;
            document.getElementById('original-price').textContent = `$${meal.original_price}`;
            document.getElementById('savings-amount').textContent = `$${(meal.original_price - meal.discounted_price).toFixed(2)}`;
            
            // Details
            document.getElementById('cuisine-type').textContent = meal.cuisine_type || 'Not specified';
            document.getElementById('meal-type').textContent = meal.meal_type || 'Not specified';
            document.getElementById('available-quantity').textContent = `${meal.quantity_available} portion${meal.quantity_available !== 1 ? 's' : ''}`;
            
            // Pickup time
            if (meal.pickup_times) {
                try {
                    const pickupTimes = JSON.parse(meal.pickup_times);
                    document.getElementById('pickup-time').textContent = `${pickupTimes.start} - ${pickupTimes.end}`;
                } catch (e) {
                    document.getElementById('pickup-time').textContent = meal.pickup_times;
                }
            } else {
                document.getElementById('pickup-time').textContent = 'Contact vendor';
            }
            
            // Dietary information
            if (meal.dietary_restrictions && meal.dietary_restrictions.length > 0) {
                document.getElementById('dietary-info').style.display = 'block';
                const dietaryContainer = document.getElementById('dietary-tags');
                dietaryContainer.innerHTML = meal.dietary_restrictions.map(diet => 
                    `<span class="badge bg-success text-white">${diet}</span>`
                ).join('');
            }
            
            // Allergen information
            if (meal.allergens && meal.allergens.length > 0) {
                document.getElementById('allergen-info').style.display = 'block';
                const allergenContainer = document.getElementById('allergen-tags');
                allergenContainer.innerHTML = meal.allergens.map(allergen => 
                    `<span class="badge bg-warning text-white">${allergen}</span>`
                ).join('');
            }
            
            // Update total price
            updateTotalPrice();
            
            // Check if meal is available
            if (meal.quantity_available === 0 || !meal.is_available) {
                document.getElementById('add-to-cart-btn').disabled = true;
                document.getElementById('add-to-cart-btn').textContent = 'Sold Out';
            }
        }

        function updateQuantity(change) {
            const newQuantity = selectedQuantity + change;
            
            if (newQuantity < 1 || newQuantity > currentMeal.quantity_available) {
                return;
            }
            
            selectedQuantity = newQuantity;
            document.getElementById('selected-quantity').textContent = selectedQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            if (currentMeal) {
                const total = currentMeal.discounted_price * selectedQuantity;
                document.getElementById('total-price').textContent = `$${total.toFixed(2)}`;
            }
        }

        function addToCart() {
            if (!currentMeal) return;
            
            // Add to cart logic
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            
            // Check if item already in cart
            const existingItem = cartItems.find(item => item.mealId === currentMeal.id);
            
            if (existingItem) {
                existingItem.quantity = Math.min(existingItem.quantity + selectedQuantity, currentMeal.quantity_available);
            } else {
                cartItems.push({
                    mealId: currentMeal.id,
                    quantity: selectedQuantity,
                    addedAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            window.chopNowApp.updateCartCount();
            window.chopNowApp.showNotification(`Added ${selectedQuantity} item(s) to cart!`, 'success');
        }

        function toggleFavorite() {
            // Favorite functionality
            window.chopNowApp.showNotification('Favorites feature coming soon!', 'info');
        }

        function shareMeal() {
            if (navigator.share) {
                navigator.share({
                    title: currentMeal.name,
                    text: `Check out this amazing meal: ${currentMeal.name}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    window.chopNowApp.showNotification('Link copied to clipboard!', 'success');
                });
            }
        }

        async function loadReviews(mealId) {
            try {
                const response = await window.chopNowApp.makeRequest(`/reviews/meal/${mealId}`);
                displayReviews(response.reviews);
            } catch (error) {
                console.error('Failed to load reviews:', error);
                document.getElementById('reviews-container').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500">No reviews available</p>
                    </div>
                `;
            }
        }

        function displayReviews(reviews) {
            const container = document.getElementById('reviews-container');
            
            if (reviews.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">‚≠ê</div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">No reviews yet</h3>
                        <p class="text-gray-500">Be the first to review this meal!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = reviews.map(review => `
                <div class="review-card card mb-4">
                    <div class="card-body">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold">${review.consumer_name}</h4>
                                <div class="flex items-center gap-2">
                                    <div class="stars text-yellow-500">${'‚≠ê'.repeat(review.rating)}</div>
                                    <span class="text-sm text-gray-500">${new Date(review.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-3">${review.comment}</p>
                        ${review.vendor_response ? `
                            <div class="vendor-response bg-gray-50 p-3 rounded-lg">
                                <h5 class="font-semibold text-sm text-gray-700 mb-1">Vendor Response:</h5>
                                <p class="text-sm text-gray-600">${review.vendor_response}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadRelatedMeals(vendorId, currentMealId) {
            try {
                const response = await window.chopNowApp.makeRequest(`/meals?vendor=${vendorId}&limit=4`);
                const relatedMeals = response.meals.filter(meal => meal.id !== parseInt(currentMealId));
                
                if (relatedMeals.length > 0) {
                    displayRelatedMeals(relatedMeals);
                } else {
                    document.querySelector('.related-meals-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load related meals:', error);
                document.querySelector('.related-meals-section').style.display = 'none';
            }
        }

        function displayRelatedMeals(meals) {
            const container = document.getElementById('related-meals');
            container.innerHTML = meals.map(meal => `
                <div class="card meal-card">
                    <div class="meal-image">
                        <img src="${meal.image_url || 'https://via.placeholder.com/300x200?text=Meal'}" 
                             alt="${meal.name}" class="w-full h-48 object-cover">
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${meal.name}</h3>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-primary">$${meal.discounted_price}</span>
                                <span class="text-sm text-gray-500 line-through">$${meal.original_price}</span>
                            </div>
                        </div>
                        <a href="meal-details.html?id=${meal.id}" class="btn btn-primary w-full">
                            View Details
                        </a>
                    </div>
                </div>
            `).join('');
        }

        function showError() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
        }
    </script>
    <script src="script.js"></script>

    <style>
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .breadcrumb-link {
            color: var(--gray-600);
            text-decoration: none;
        }
        
        .breadcrumb-link:hover {
            color: var(--primary-color);
        }
        
        .breadcrumb-separator {
            color: var(--gray-400);
        }
        
        .breadcrumb-current {
            color: var(--gray-800);
            font-weight: 600;
        }
        
        .discount-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .main-image {
            position: relative;
        }
        
        .quantity-selector .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .quantity-selector .quantity-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary-color);
        }
        
        .quantity-display {
            min-width: 3rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        .review-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .vendor-response {
            border-left: 3px solid var(--secondary-color);
        }
        
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .meal-details-grid .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .flex.gap-3 {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>